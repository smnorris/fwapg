<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Function reference &mdash; fwapg 0.5.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Table reference" href="03_tables.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            fwapg
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_setup.html">Setup and data load</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_tables.html">Table reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Function reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#fwa-downstream">FWA_Downstream</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#synopsis">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#description">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fwa-indexpoint">FWA_IndexPoint</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#options">Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#web-service">Web service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fwa-locatealong">FWA_LocateAlong</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">Web service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fwa-locatealonginterval">FWA_LocateAlongInterval</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">Web service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fwa-streamsasmvt">FWA_StreamsAsMVT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id11">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">Web service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fwa-upstream">FWA_Upstream</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id14">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id15">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fwa-upstreamtrace">FWA_UpstreamTrace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id17">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id19">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id20">Web service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fwa-watershedatmeasure">FWA_WatershedAtMeasure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id21">Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id22">Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id23">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id24">Web service</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">fwapg</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Function reference</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/04_functions.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="function-reference">
<h1>Function reference<a class="headerlink" href="#function-reference" title="Permalink to this heading"></a></h1>
<section id="fwa-downstream">
<h2>FWA_Downstream<a class="headerlink" href="#fwa-downstream" title="Permalink to this heading"></a></h2>
<section id="synopsis">
<h3>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FWA_Downstream</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">wscode</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">localcode</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">wscode</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">localcode</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">ltree</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="n">FWA_Downstream</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">blue_line_key</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">downstream_route_measure</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">wscode_ltree</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">localcode_ltree</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">blue_line_key</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">downstream_route_measure</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">wscode_ltree</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">localcode_ltree</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">include_equivalents</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">False</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tolerance</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">.</span><span class="mi">001</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="description">
<h3>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h3>
<p>Return <code class="docutils literal notranslate"><span class="pre">True</span></code> if the watershed codes / measures B are downstream of watershed codes / measure A.</p>
<p>For polygonal features (where no <code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code> / <code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code> is present), use the shorter form of the function.</p>
<p>For point locations referenced to the stream network, use the form of the function with <code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code> and <code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code>.  Also, specify <code class="docutils literal notranslate"><span class="pre">True</span></code> for <code class="docutils literal notranslate"><span class="pre">include_equivalents</span></code> if you want to evaluate as true for features with exactly the same linear position.</p>
</section>
<section id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h3>
<ol class="arabic">
<li><p>At its most basic, the function compares two watershed code / local code <code class="docutils literal notranslate"><span class="pre">ltree</span></code> pairs and returns <code class="docutils literal notranslate"><span class="pre">True</span></code> if the second pair is a parent of the first set (ie, downstream).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">FWA_Downstream</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;100.100000.000100&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;100.100000.000100&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;100.100000&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;100.100000&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">fwa_downstream</span>
<span class="o">----------------</span>
 <span class="n">t</span>
</pre></div>
</div>
</li>
<li><p>Find features downstream of a known location on the network - this query finds the total length of stream downstream from Hope. Note that this result includes side channels, it is not necessarily the distance to the ocean:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="n">ROUND</span><span class="p">((</span><span class="k">SUM</span><span class="p">(</span><span class="n">st_length</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">length_dnstr_km</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">whse_basemapping</span><span class="p">.</span><span class="n">fwa_stream_networks_sp</span><span class="w"> </span><span class="n">s</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">FWA_Downstream</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="mi">356364114</span><span class="p">,</span><span class="w"> </span><span class="mi">160400</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;100&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;100.113848&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">blue_line_key</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">downstream_route_measure</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">wscode_ltree</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">localcode_ltree</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">length_dnstr_km</span>
<span class="o">-----------------</span>
          <span class="mf">308.54</span>
</pre></div>
</div>
<p>Refine this slightly to find the distance to the ocean along the Fraser mainstem (where <code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code> is equal to <code class="docutils literal notranslate"><span class="pre">watershed_key</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="n">ROUND</span><span class="p">((</span><span class="k">SUM</span><span class="p">(</span><span class="n">st_length</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">length_dnstr_km</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">whse_basemapping</span><span class="p">.</span><span class="n">fwa_stream_networks_sp</span><span class="w"> </span><span class="n">s</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">FWA_Downstream</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="mi">356364114</span><span class="p">,</span><span class="w"> </span><span class="mi">160400</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;100&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;100.113848&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">blue_line_key</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">downstream_route_measure</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">wscode_ltree</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">localcode_ltree</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="n">watershed_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blue_line_key</span><span class="p">;</span><span class="w"> </span><span class="c1">-- do not include side channels</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">length_dnstr_km</span>
<span class="o">-----------------</span>
          <span class="mf">161.40</span>
</pre></div>
</div>
</li>
<li><p>For each feature in table A, find all records downstream in table B and collect them into an array. This query lists all dams downstream of each fish passage field assessment location (data from <a class="reference external" href="https://github.com/smnorris/bcfishpass"><code class="docutils literal notranslate"><span class="pre">bcfishpass</span></code></a>)</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">aggregated_crossings_id</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">array_agg</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">dam_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">downstream_dam_ids</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">bcfishpass</span><span class="p">.</span><span class="n">crossings</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">bcfishpass</span><span class="p">.</span><span class="n">dams</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="k">ON</span><span class="w"> </span><span class="n">FWA_Downstream</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">blue_line_key</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">downstream_route_measure</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">wscode_ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">localcode_ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">blue_line_key</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">downstream_route_measure</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">wscode_ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">localcode_ltree</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">stream_crossing_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">aggregated_crossings_id</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">aggregated_crossings_id</span> <span class="o">|</span> <span class="n">downstream_dam_ids</span>
<span class="o">-------------------------+-----------------------</span>
                    <span class="mi">4790</span> <span class="o">|</span> <span class="p">{</span><span class="mi">2343</span><span class="p">}</span>
                   <span class="mi">69233</span> <span class="o">|</span> <span class="p">{</span><span class="mi">917</span><span class="p">,</span><span class="mi">1801</span><span class="p">,</span><span class="mi">2165</span><span class="p">,</span><span class="mi">2310</span><span class="p">}</span>
                    <span class="mi">5468</span> <span class="o">|</span> <span class="p">{</span><span class="mi">2472</span><span class="p">}</span>
                  <span class="mi">125252</span> <span class="o">|</span> <span class="p">{</span><span class="mi">15</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">1917</span><span class="p">}</span>
                    <span class="mi">5697</span> <span class="o">|</span> <span class="p">{</span><span class="mi">2472</span><span class="p">}</span>
                     <span class="mi">176</span> <span class="o">|</span> <span class="p">{</span><span class="mi">2472</span><span class="p">}</span>
                     <span class="mi">576</span> <span class="o">|</span> <span class="p">{</span><span class="mi">426</span><span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="fwa-indexpoint">
<h2>FWA_IndexPoint<a class="headerlink" href="#fwa-indexpoint" title="Permalink to this heading"></a></h2>
<section id="id1">
<h3>Synopsis<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FWA_IndexPoint</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">point</span><span class="w"> </span><span class="n">geometry</span><span class="p">(</span><span class="n">Point</span><span class="p">,</span><span class="w"> </span><span class="mi">3005</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">tolerance</span><span class="w"> </span><span class="nb">float</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">num_features</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="n">FWA_IndexPoint</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="nb">float</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="nb">float</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">srid</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tolerance</span><span class="w"> </span><span class="nb">float</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">num_features</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>Description<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>Snaps a point to the stream network. Provided a point (as either a BC Albers point geometry or (<code class="docutils literal notranslate"><span class="pre">x,</span> <span class="pre">y,</span> <span class="pre">srid</span></code>), return a table containing the point geometry/geometries of the closest point(s) on the FWA stream network to the given point, plus additional attributes from the matched stream(s).</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>field</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">linear_feature_id</span></code></p></td>
<td><p>bigint</p></td>
<td><p>unique identifier of matched stream</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">gnis_name</span></code></p></td>
<td><p>text</p></td>
<td><p>stream name of matched stream</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">wscode_ltree</span></code></p></td>
<td><p>ltree</p></td>
<td><p>stream watershed code</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">localcode_ltree</span></code></p></td>
<td><p>ltree</p></td>
<td><p>stream local watershed code</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code></p></td>
<td><p>integer</p></td>
<td><p>stream blue line key (route identifier)</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code></p></td>
<td><p>double precision</p></td>
<td><p>measure value of output point</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">distance_to_stream</span></code></p></td>
<td><p>double precision</p></td>
<td><p>distance from input point to output point</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">bc_ind</span></code></p></td>
<td><p>boolean</p></td>
<td><p>Indicates if the source point is in BC</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">geom</span></code></p></td>
<td><p>geometry(Point, 3005)</p></td>
<td><p>The closest point on the FWA stream network</p></td>
</tr>
</tbody>
</table>
</section>
<section id="options">
<h3>Options<a class="headerlink" href="#options" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">tolerance</span></code> - Return only stream feature(s) within this distance (metres) (default = <code class="docutils literal notranslate"><span class="pre">5000</span></code>)<br />
<code class="docutils literal notranslate"><span class="pre">num_features</span></code> - Number of features to be returned (default = <code class="docutils literal notranslate"><span class="pre">1</span></code>)</p>
</section>
<section id="id3">
<h3>Examples<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h3>
<ol class="arabic">
<li><p>Return the closest point on FWA stream network to a point defined by a lon/lat (within default 5000m tolerance):</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">FWA_IndexPoint</span><span class="p">(</span><span class="o">-</span><span class="mi">123</span><span class="p">.</span><span class="mi">7028</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">.</span><span class="mi">3858</span><span class="p">,</span><span class="w"> </span><span class="mi">4326</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">linear_feature_id</span> <span class="o">|</span>  <span class="n">gnis_name</span>  <span class="o">|</span> <span class="n">wscode_ltree</span> <span class="o">|</span> <span class="n">localcode_ltree</span> <span class="o">|</span> <span class="n">blue_line_key</span> <span class="o">|</span> <span class="n">downstream_route_measure</span> <span class="o">|</span> <span class="n">distance_to_stream</span> <span class="o">|</span> <span class="n">bc_ind</span> <span class="o">|</span>                        <span class="n">geom</span>
<span class="o">-------------------+-------------+--------------+-----------------+---------------+--------------------------+--------------------+--------+----------------------------------------------------</span>
         <span class="mi">710513719</span> <span class="o">|</span> <span class="n">Sooke</span> <span class="n">River</span> <span class="o">|</span> <span class="mf">930.023810</span>   <span class="o">|</span> <span class="mf">930.023810</span>      <span class="o">|</span>     <span class="mi">354153927</span> <span class="o">|</span>        <span class="mf">350.2530543284006</span> <span class="o">|</span>             <span class="mf">24.228</span> <span class="o">|</span> <span class="n">t</span>      <span class="o">|</span> <span class="mi">0101000020</span><span class="n">BD0B0000D579287B42DC314198937D515C061741</span>
</pre></div>
</div>
</li>
<li><p>Index a set of point geometries, finding up to 10 features within 100m:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="n">pts</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">i</span><span class="p">.</span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">VALUES</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="s1">&#39;07EA004&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">1054676</span><span class="p">,</span><span class="w"> </span><span class="mi">1304723</span><span class="p">),</span><span class="w"> </span><span class="mi">3005</span><span class="p">)),</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="s1">&#39;07EA005&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">1045356</span><span class="p">,</span><span class="w"> </span><span class="mi">1348750</span><span class="p">),</span><span class="w"> </span><span class="mi">3005</span><span class="p">)),</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="s1">&#39;07EA007&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">1066334</span><span class="p">,</span><span class="w"> </span><span class="mi">1356262</span><span class="p">),</span><span class="w"> </span><span class="mi">3005</span><span class="p">)),</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="s1">&#39;07EB002&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">1126747</span><span class="p">,</span><span class="w"> </span><span class="mi">1283184</span><span class="p">),</span><span class="w"> </span><span class="mi">3005</span><span class="p">)),</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="s1">&#39;07EC002&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="mi">1089342</span><span class="p">,</span><span class="w"> </span><span class="mi">1214473</span><span class="p">),</span><span class="w"> </span><span class="mi">3005</span><span class="p">))</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pts</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">geom</span><span class="p">)</span><span class="w"></span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">LATERAL</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"></span>
<span class="w">  </span><span class="n">FWA_IndexPoint</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">true</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="nb">id</span>    <span class="o">|</span> <span class="n">linear_feature_id</span> <span class="o">|</span>   <span class="n">gnis_name</span>    <span class="o">|</span>       <span class="n">wscode_ltree</span>       <span class="o">|</span>         <span class="n">localcode_ltree</span>         <span class="o">|</span> <span class="n">blue_line_key</span> <span class="o">|</span> <span class="n">downstream_route_measure</span> <span class="o">|</span> <span class="n">distance_to_stream</span> <span class="o">|</span> <span class="n">bc_ind</span> <span class="o">|</span>                        <span class="n">geom</span>
<span class="o">---------+-------------------+----------------+--------------------------+---------------------------------+---------------+--------------------------+--------------------+--------+----------------------------------------------------</span>
 <span class="mi">07</span><span class="n">EA004</span> <span class="o">|</span>          <span class="mi">68051401</span> <span class="o">|</span> <span class="n">Ingenika</span> <span class="n">River</span> <span class="o">|</span> <span class="mf">200.948755.992594</span>        <span class="o">|</span> <span class="mf">200.948755.992594.039418</span>        <span class="o">|</span>     <span class="mi">359571145</span> <span class="o">|</span>        <span class="mf">6096.256539019577</span> <span class="o">|</span>             <span class="mf">41.319</span> <span class="o">|</span> <span class="n">t</span>      <span class="o">|</span> <span class="mi">0101000020</span><span class="n">BD0B00007FFBC4C0C617304173BF3D23BAE83341</span>
 <span class="mi">07</span><span class="n">EA004</span> <span class="o">|</span>          <span class="mi">68051402</span> <span class="o">|</span>                <span class="o">|</span> <span class="mf">200.948755.992594.042767</span> <span class="o">|</span> <span class="mf">200.948755.992594.042767</span>        <span class="o">|</span>     <span class="mi">359233576</span> <span class="o">|</span>                        <span class="mi">0</span> <span class="o">|</span>              <span class="mf">46.77</span> <span class="o">|</span> <span class="n">t</span>      <span class="o">|</span> <span class="mi">0101000020</span><span class="n">BD0B000023DBF9FEB11730413108AC1CB3E83341</span>
 <span class="mi">07</span><span class="n">EA005</span> <span class="o">|</span>          <span class="mi">49095881</span> <span class="o">|</span> <span class="n">Finlay</span> <span class="n">River</span>   <span class="o">|</span> <span class="mf">200.948755.999851</span>        <span class="o">|</span> <span class="mf">200.948755.999851.137838</span>        <span class="o">|</span>     <span class="mi">359569942</span> <span class="o">|</span>        <span class="mf">42909.36746325051</span> <span class="o">|</span>             <span class="mf">47.258</span> <span class="o">|</span> <span class="n">t</span>      <span class="o">|</span> <span class="mi">0101000020</span><span class="n">BD0B0000C3F5289C79E62F41508D976E90943441</span>
 <span class="mi">07</span><span class="n">EA007</span> <span class="o">|</span>          <span class="mi">49083226</span> <span class="o">|</span> <span class="n">Akie</span> <span class="n">River</span>     <span class="o">|</span> <span class="mf">200.948755.999851.088011</span> <span class="o">|</span> <span class="mf">200.948755.999851.088011.231827</span> <span class="o">|</span>     <span class="mi">359571761</span> <span class="o">|</span>        <span class="mf">29215.40257114563</span> <span class="o">|</span>             <span class="mf">40.442</span> <span class="o">|</span> <span class="n">t</span>      <span class="o">|</span> <span class="mi">0101000020</span><span class="n">BD0B000037B9E4F44B4530410DDF6ACEC1B13441</span>
 <span class="mi">07</span><span class="n">EB002</span> <span class="o">|</span>         <span class="mi">161051216</span> <span class="o">|</span> <span class="n">Ospika</span> <span class="n">River</span>   <span class="o">|</span> <span class="mf">200.948755.951156</span>        <span class="o">|</span> <span class="mf">200.948755.951156.201899</span>        <span class="o">|</span>     <span class="mi">359573063</span> <span class="o">|</span>       <span class="mf">29005.449548147713</span> <span class="o">|</span>             <span class="mf">41.647</span> <span class="o">|</span> <span class="n">t</span>      <span class="o">|</span> <span class="mi">0101000020</span><span class="n">BD0B0000D7D491C73F3131419708AD7A50943341</span>
 <span class="mi">07</span><span class="n">EC002</span> <span class="o">|</span>         <span class="mi">115033725</span> <span class="o">|</span> <span class="n">Omineca</span> <span class="n">River</span>  <span class="o">|</span> <span class="mf">200.948755.944288</span>        <span class="o">|</span> <span class="mf">200.948755.944288.110746</span>        <span class="o">|</span>     <span class="mi">359571933</span> <span class="o">|</span>        <span class="mf">29317.40902691083</span> <span class="o">|</span>             <span class="mf">95.125</span> <span class="o">|</span> <span class="n">t</span>      <span class="o">|</span> <span class="mi">0101000020</span><span class="n">BD0B000054618DD09A9F3041A0D25C29F4873241</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="web-service">
<h3>Web service<a class="headerlink" href="#web-service" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://features.hillcrestgeo.ca/fwa/functions/fwa_indexpoint.html">FWA_IndexPoint</a></p>
</section>
</section>
<section id="fwa-locatealong">
<h2>FWA_LocateAlong<a class="headerlink" href="#fwa-locatealong" title="Permalink to this heading"></a></h2>
<section id="id4">
<h3>Synopsis<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FWA_LocateAlong</span><span class="p">(</span><span class="n">blue_line_key</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"> </span><span class="n">downstream_route_measure</span><span class="w"> </span><span class="nb">float</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>Description<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<p>Return a table containing a single point geometry corresponding to the position on the FWA stream network of input <code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code>, <code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code>.</p>
</section>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h3>
<p>Create a point geometry at measure 25,000 on the Skeena River:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">ST_AsText</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">FWA_LocateAlong</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">blue_line_key</span><span class="w"></span>
<span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="n">whse_basemapping</span><span class="p">.</span><span class="n">fwa_stream_networks_sp</span><span class="w"></span>
<span class="w">            </span><span class="k">WHERE</span><span class="w"> </span><span class="n">gnis_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Skeena River&#39;</span><span class="w"></span>
<span class="w">          </span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="mi">25000</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                         <span class="n">st_astext</span>
<span class="o">-----------------------------------------------------------</span>
 <span class="n">POINT</span> <span class="n">ZM</span> <span class="p">(</span><span class="mf">754013.9457165595</span> <span class="mf">1029911.1568720527</span> <span class="mf">5.5</span> <span class="mi">25000</span><span class="p">)</span>

</pre></div>
</div>
</section>
<section id="id6">
<h3>Web service<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://features.hillcrestgeo.ca/fwa/functions/fwa_locatealong.html">FWA_LocateAlong</a></p>
</section>
</section>
<section id="fwa-locatealonginterval">
<h2>FWA_LocateAlongInterval<a class="headerlink" href="#fwa-locatealonginterval" title="Permalink to this heading"></a></h2>
<section id="id7">
<h3>Synopsis<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FWA_LocateAlongInterval</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">blue_line_key</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">start_measure</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">interval_length</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">end_measure</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>Description<a class="headerlink" href="#id8" title="Permalink to this heading"></a></h3>
<p>Return a table representing points along a stream between input locations at specified interval.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>field</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">index</span></code></p></td>
<td><p>integer</p></td>
<td><p>0 based index of returned features</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code></p></td>
<td><p>double precision</p></td>
<td><p>measure value of output point</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">geom</span></code></p></td>
<td><p>geometry(Point, 3005)</p></td>
<td><p>Point geometry at the measure</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id9">
<h3>Example<a class="headerlink" href="#id9" title="Permalink to this heading"></a></h3>
<p>Return points at a 1km interval along the Peace between Site C and Bennet dams:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">     </span><span class="k">index</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">downstream_route_measure</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">FWA_LocateAlongInterval</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">359572348</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">1597489</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">1000</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">1706733</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="nb">id</span>  <span class="o">|</span> <span class="n">downstream_route_measure</span> <span class="o">|</span>                                  <span class="n">st_astext</span>
<span class="o">-----+--------------------------+-----------------------------------------------------------------------------</span>
   <span class="mi">0</span> <span class="o">|</span>                  <span class="mi">1597489</span> <span class="o">|</span> <span class="n">POINT</span> <span class="n">ZM</span> <span class="p">(</span><span class="mf">1314468.0708699157</span> <span class="mf">1256099.567354601</span> <span class="mf">412.98247677532964</span> <span class="mi">1597489</span><span class="p">)</span>
   <span class="mi">1</span> <span class="o">|</span>                  <span class="mi">1598489</span> <span class="o">|</span> <span class="n">POINT</span> <span class="n">ZM</span> <span class="p">(</span><span class="mf">1313779.3421101477</span> <span class="mf">1256817.5566858777</span> <span class="mf">413.709000000003</span> <span class="mi">1598489</span><span class="p">)</span>
   <span class="mi">2</span> <span class="o">|</span>                  <span class="mi">1599489</span> <span class="o">|</span> <span class="n">POINT</span> <span class="n">ZM</span> <span class="p">(</span><span class="mf">1313217.588407995</span> <span class="mf">1257612.8656611862</span> <span class="mf">413.9290255060764</span> <span class="mi">1599489</span><span class="p">)</span>
   <span class="mi">3</span> <span class="o">|</span>                  <span class="mi">1600489</span> <span class="o">|</span> <span class="n">POINT</span> <span class="n">ZM</span> <span class="p">(</span><span class="mf">1312633.1479665248</span> <span class="mf">1258419.2668507479</span> <span class="mi">414</span> <span class="mi">1600489</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Mapping the returned features:</p>
<p><img alt="watershed" src="_images/locatealonginterval.png" /></p>
</section>
<section id="id10">
<h3>Web service<a class="headerlink" href="#id10" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://features.hillcrestgeo.ca/fwa/functions/fwa_locatealonginterval.html">FWA_LocateAlongInterval</a></p>
<p>Make the same request as the example above, but
<a class="reference external" href="https://features.hillcrestgeo.ca/fwa/functions/fwa_locatealonginterval/items.html?blue_line_key=359572348&amp;amp;start_measure=1597489&amp;amp;interval_length=10000&amp;amp;end_measure=1706733&amp;amp;limit=100">at 10km</a></p>
</section>
</section>
<section id="fwa-streamsasmvt">
<h2>FWA_StreamsAsMVT<a class="headerlink" href="#fwa-streamsasmvt" title="Permalink to this heading"></a></h2>
<section id="id11">
<h3>Synopsis<a class="headerlink" href="#id11" title="Permalink to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FWA_StreamsAsMVT</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">z</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="nb">integer</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id12">
<h3>Description<a class="headerlink" href="#id12" title="Permalink to this heading"></a></h3>
<p>Return FWA streams as MVT, filtering by <code class="docutils literal notranslate"><span class="pre">stream_order_max</span></code> (the maximum order of a given stream / <code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code>) based on the provided zoom level.
Enables fast display of source 1:20,000 streams at all zoom levels (show full length of higher order streams at lower zooms), using <code class="docutils literal notranslate"><span class="pre">pg_tileserv</span></code>.</p>
<p>Note: for databases with modest resources, tiles at low zoom levels may be slow to render. The function should still be speedy enough for general use if <a class="reference external" href="https://github.com/CrunchyData/pg_tileserv#basic-operation">pg_tileserv is behind a cache</a>.</p>
</section>
<section id="id13">
<h3>Web service<a class="headerlink" href="#id13" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://tiles.hillcrestgeo.ca/bcfishpass/postgisftw.fwa_streamsasmvt.html">FWA_StreamsAsMVT</a></p>
</section>
</section>
<section id="fwa-upstream">
<h2>FWA_Upstream<a class="headerlink" href="#fwa-upstream" title="Permalink to this heading"></a></h2>
<section id="id14">
<h3>Synopsis<a class="headerlink" href="#id14" title="Permalink to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- compare watershed codes only</span>
<span class="n">FWA_Upstream</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">wscode_ltree_a</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">localcode_ltree_a</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">wscode_ltree_b</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">localcode_ltree_b</span><span class="w"> </span><span class="n">ltree</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">-- compare watershed codes and route positions (lines)</span>
<span class="n">FWA_Upstream</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">blue_line_key_a</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">downstream_route_measure_a</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">upstream_route_measure_a</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">wscode_ltree_a</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">localcode_ltree_a</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">blue_line_key_b</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">downstream_route_measure_b</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">wscode_ltree_b</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">localcode_ltree_b</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">include_equivalents</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">False</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tolerance</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">.</span><span class="mi">001</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="c1">-- compare watershed codes and route positions (points)</span>
<span class="n">FWA_Upstream</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">blue_line_key_a</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">downstream_route_measure_a</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">wscode_ltree_a</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">localcode_ltree_a</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">blue_line_key_b</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">downstream_route_measure_b</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">wscode_ltree_b</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">localcode_ltree_b</span><span class="w"> </span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">include_equivalents</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">False</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tolerance</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">precision</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">.</span><span class="mi">001</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id15">
<h3>Description<a class="headerlink" href="#id15" title="Permalink to this heading"></a></h3>
<p>Return <code class="docutils literal notranslate"><span class="pre">True</span></code> if the watershed codes / measures B are upstream of watershed codes / measure A.</p>
<p>For polygonal features (where no <code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code> / <code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code> is present), use the shorter form of the function.</p>
<p>For line features, use the form of the function with <code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code>, <code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code> and <code class="docutils literal notranslate"><span class="pre">upstream_route_measure</span></code></p>
<p>For point features, use the form of the function with <code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code> and <code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code>, but not <code class="docutils literal notranslate"><span class="pre">upstream_route_measure</span></code></p>
<p>Specify <code class="docutils literal notranslate"><span class="pre">True</span></code> for <code class="docutils literal notranslate"><span class="pre">include_equivalents</span></code> if you want to evaluate as true for features with exactly the same linear position.</p>
</section>
<section id="id16">
<h3>Examples<a class="headerlink" href="#id16" title="Permalink to this heading"></a></h3>
<ol class="arabic">
<li><p>At its most basic, the function compares two watershed code / local code <code class="docutils literal notranslate"><span class="pre">ltree</span></code> pairs and returns <code class="docutils literal notranslate"><span class="pre">True</span></code> if the second pair is upstream of the first pair.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">FWA_Upstream</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;100.100000&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;100.100000&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;100.100000.000100&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;100.100000.000100&#39;</span><span class="p">::</span><span class="n">ltree</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">fwa_upstream</span>
<span class="o">--------------</span>
 <span class="n">t</span>
</pre></div>
</div>
</li>
<li><p>Find features upstream of a known location on the network. This query finds the number of lakes upstream of the Mission/Terzaghi Dam on the Bridge River. As source FWA lakes do not have a <code class="docutils literal notranslate"><span class="pre">local_watershed_code</span></code> value, we use the <code class="docutils literal notranslate"><span class="pre">fwapg</span></code> lookup.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">n_lakes</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">whse_basemapping</span><span class="p">.</span><span class="n">fwa_lakes_poly</span><span class="w"> </span><span class="n">l</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">whse_basemapping</span><span class="p">.</span><span class="n">fwa_waterbodies</span><span class="w"> </span><span class="n">wb</span><span class="w"></span>
<span class="k">ON</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">waterbody_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wb</span><span class="p">.</span><span class="n">waterbody_key</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">FWA_Upstream</span><span class="p">(</span><span class="s1">&#39;100.239855&#39;</span><span class="p">,</span><span class="s1">&#39;100.239855.240724&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">wb</span><span class="p">.</span><span class="n">wscode_ltree</span><span class="p">,</span><span class="w"> </span><span class="n">wb</span><span class="p">.</span><span class="n">localcode_ltree</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">n_lakes</span>
<span class="o">---------</span>
     <span class="mi">998</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>For each feature in table A, find all records upstream in table B and collect them into an array. This query lists all dams upstream of each fish passage field assessment location (data from <a class="reference external" href="https://github.com/smnorris/bcfishpass"><code class="docutils literal notranslate"><span class="pre">bcfishpass</span></code></a>)</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">aggregated_crossings_id</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">array_agg</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">dam_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">upstream_dam_ids</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">bcfishpass</span><span class="p">.</span><span class="n">crossings</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">bcfishpass</span><span class="p">.</span><span class="n">dams</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="k">ON</span><span class="w"> </span><span class="n">FWA_Upstream</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">blue_line_key</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">downstream_route_measure</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">wscode_ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="n">localcode_ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">blue_line_key</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">downstream_route_measure</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">wscode_ltree</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">localcode_ltree</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">stream_crossing_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">aggregated_crossings_id</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">aggregated_crossings_id</span> <span class="o">|</span> <span class="n">upstream_dam_ids</span>
<span class="o">-------------------------+-----------------------</span>
                   <span class="mi">69195</span> <span class="o">|</span> <span class="p">{</span><span class="mi">163</span><span class="p">}</span>
                  <span class="mi">196198</span> <span class="o">|</span> <span class="p">{</span><span class="mi">1427</span><span class="p">,</span><span class="mi">2362</span><span class="p">}</span>
                  <span class="mi">195590</span> <span class="o">|</span> <span class="p">{</span><span class="mi">1914</span><span class="p">}</span>
                   <span class="mi">51959</span> <span class="o">|</span> <span class="p">{</span><span class="mi">2371</span><span class="p">}</span>
                  <span class="mi">103090</span> <span class="o">|</span> <span class="p">{</span><span class="mi">1085</span><span class="p">,</span><span class="mi">1693</span><span class="p">,</span><span class="mi">1483</span><span class="p">}</span>
                  <span class="mi">103088</span> <span class="o">|</span> <span class="p">{</span><span class="mi">1693</span><span class="p">}</span>
                    <span class="mi">7520</span> <span class="o">|</span> <span class="p">{</span><span class="mi">416</span><span class="p">,</span><span class="mi">1129</span><span class="p">,</span><span class="mi">708</span><span class="p">,</span><span class="mi">1937</span><span class="p">,</span><span class="mi">1128</span><span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="fwa-upstreamtrace">
<h2>FWA_UpstreamTrace<a class="headerlink" href="#fwa-upstreamtrace" title="Permalink to this heading"></a></h2>
<section id="id17">
<h3>Synopsis<a class="headerlink" href="#id17" title="Permalink to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FWA_UpstreamTrace</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">start_blue_line_key</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">start_measure</span><span class="w"> </span><span class="nb">float</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">tolerance</span><span class="w"> </span><span class="nb">float</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id18">
<h3>Description<a class="headerlink" href="#id18" title="Permalink to this heading"></a></h3>
<p>Return all records from <code class="docutils literal notranslate"><span class="pre">whse_basemapping.fwa_stream_networks_sp</span></code> that are upstream of provided location.
Where the provided location is more than the provided tolerance (metres) from the endpoint of the stream segment
on which it lies, split the source stream segment and only include the portion upstream of the location in the returned records.</p>
</section>
<section id="id19">
<h3>Example<a class="headerlink" href="#id19" title="Permalink to this heading"></a></h3>
<p>A common use case would be to use this in combination with <code class="docutils literal notranslate"><span class="pre">FWA_IndexPoint</span></code>, extracting streams upstream of coordinates of a feature like a bridge:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- find blkey/measure of bridge over sooke river</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">blue_line_key</span><span class="p">,</span><span class="w"> </span><span class="n">downstream_route_measure</span><span class="w"> </span>
<span class="k">FROM</span><span class="w"> </span><span class="n">postgisftw</span><span class="p">.</span><span class="n">FWA_IndexPoint</span><span class="p">(</span><span class="o">-</span><span class="mi">123</span><span class="p">.</span><span class="mi">7028</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">.</span><span class="mi">3858</span><span class="p">,</span><span class="w"> </span><span class="mi">4326</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">blue_line_key</span> <span class="o">|</span> <span class="n">downstream_route_measure</span> 
<span class="o">---------------+--------------------------</span>
 <span class="mi">354153927</span>     <span class="o">|</span>        <span class="mf">350.3003598130115</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- extract streams</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">FWA_UpstreamTrace</span><span class="p">(</span><span class="mi">354153927</span><span class="p">,</span><span class="w"> </span><span class="mi">350</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id20">
<h3>Web service<a class="headerlink" href="#id20" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://features.hillcrestgeo.ca/fwa/functions/fwa_upstreamtrace.html">FWA_UpstreamTrace</a></p>
</section>
</section>
<section id="fwa-watershedatmeasure">
<h2>FWA_WatershedAtMeasure<a class="headerlink" href="#fwa-watershedatmeasure" title="Permalink to this heading"></a></h2>
<section id="id21">
<h3>Synopsis<a class="headerlink" href="#id21" title="Permalink to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FWA_WatershedAtMeasure</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">blue_line_key</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">downstream_route_measure</span><span class="w"> </span><span class="nb">float</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id22">
<h3>Description<a class="headerlink" href="#id22" title="Permalink to this heading"></a></h3>
<p>Given a point defined by its position on the FWA stream network (<code class="docutils literal notranslate"><span class="pre">blue_line_key</span></code>,<code class="docutils literal notranslate"><span class="pre">downstream_route_measure</span></code>), return a table containing a polygon geometry that defines the point’s upstream watershed.</p>
<p>Watershed delineation following this set of rules, in order of descending priority:</p>
<ol class="arabic simple">
<li><p>If the point is within a lake, return everything upstream of the lake’s <em>outflow</em></p></li>
<li><p>If the point is within a polygonal river/canal the fundamental watersheds are
cut across the banks of the river/canal before being included in the aggregation</p></li>
<li><p>If the point is &lt; 100m downstream from the top of the fundamental
watershed in which it falls, then that fundamental watershed is not included in the aggregation</p></li>
<li><p>If the point is &lt; 50 m upstream from the bottom of the fundamental
watershed in which it falls, then that watershed is included in the aggregation</p></li>
</ol>
<p>For cross-boundary watersheds, the function returns non-BC areas using these data sources:</p>
<ul class="simple">
<li><p>USGS <a class="reference external" href="https://www.usgs.gov/core-science-systems/ngp/national-hydrography/watershed-boundary-dataset?qt-science_support_page_related_con=4#qt-science_support_page_related_con">huc12 watersheds</a> for USA (WA, ID, MT only)</p></li>
<li><p><a class="reference external" href="https://www.hydrosheds.org">hydrosheds</a> watersheds for other neighbouring jurisdictions</p></li>
</ul>
<p>The table returned includes these columns:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>field</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">wscode_ltree</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ltree</span></code></p></td>
<td><p>watershed code of the source point</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">localcode_ltree</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ltree</span></code></p></td>
<td><p>local watershed code of the source point</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">area_ha</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">numeric</span></code></p></td>
<td><p>area of output geometry, hectares</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">refine_method</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">text</span></code></p></td>
<td><p>how the watershed was processed / what further processing may be required</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">geom</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">geometry(Polygon,</span> <span class="pre">3005)</span></code></p></td>
<td><p>a polygon representing the watershed contributing to the input location</p></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">refine_method</span></code> field in the output table has several possible values:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>value</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">CUT</span></code></p></td>
<td><p>Input point falls in a river/canal, output geometry is cut across the banks of the river/canal</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">DEM</span></code></p></td>
<td><p>Input point falls on a linear stream &gt;50m upstream from outlet of input watershed and &gt;100m downstream from top of watershed, further processing of the fundamental watershed in which the point lies with the DEM would be valuable to improve the output watershed. This is functionally equivalent to the <code class="docutils literal notranslate"><span class="pre">DROP</span></code> value, the fundamental watershed in which the point lies is not included in the output geometry</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">DROP</span></code></p></td>
<td><p>Input point falls on a linear stream and is &lt;=100m downstream from the top of the fundamental watershed in which it lies - this fundamental watershed is not included in output geometry</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">KEEP</span></code></p></td>
<td><p>Input point falls on a linear stream and is &lt;=50m upstream from the outlet of the fundamental watershed in which it lies - this fundamental watershed is entirely retained in the output geometry</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">LAKE</span></code></p></td>
<td><p>Input point falls within a lake/reservoir - watershed returned includes everything upstream of the outlet of the lake/reservoir</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id23">
<h3>Examples<a class="headerlink" href="#id23" title="Permalink to this heading"></a></h3>
<ol class="arabic">
<li><p>Extract the geometry of the watershed upstream of the Cowichan River at Hwy 19:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">FWA_WatershedAtMeasure</span><span class="p">(</span><span class="mi">354155148</span><span class="p">,</span><span class="w"> </span><span class="mi">49129</span><span class="p">.</span><span class="mi">75</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><img alt="watershed" src="_images/watershed5.png" /></p>
</li>
<li><p>Extract the watershed upstream of Chilliwack Lake:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span><span class="w"> </span><span class="n">indexed_pt</span><span class="w"> </span><span class="k">AS</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">i</span><span class="p">.</span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- find a point in the lake</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">st_pointonsurface</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">geom</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">whse_basemapping</span><span class="p">.</span><span class="n">fwa_lakes_poly</span><span class="w"></span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">gnis_name_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Chilliwack Lake&#39;</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">pt</span><span class="w"></span>
<span class="w">  </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">LATERAL</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"></span>
<span class="w">    </span><span class="n">FWA_IndexPoint</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="c1">-- index the point in the lake to the nearest FWA stream</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">true</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">FWA_WatershedAtMeasure</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">blue_line_key</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">indexed_pt</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">downstream_route_measure</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">indexed_pt</span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">wscode_ltree</span>    <span class="o">|</span>     <span class="n">localcode_ltree</span>      <span class="o">|</span> <span class="n">area_ha</span>  <span class="o">|</span> <span class="n">refine_method</span>  <span class="o">|</span> <span class="n">geom</span>
<span class="o">-------------------+--------------------------+----------+----------------+-----</span>
 <span class="mf">100.064535.057628</span> <span class="o">|</span> <span class="mf">100.064535.057628.634957</span> <span class="o">|</span> <span class="mf">33478.28</span> <span class="o">|</span> <span class="n">LAKE</span>           <span class="o">|</span>
</pre></div>
</div>
<p>Mapped, the geometry looks like this - FWA heights of land in BC, HUC12 heights of land in the USA:</p>
<p><img alt="watershed" src="_images/watershed6.png" /></p>
</li>
</ol>
</section>
<section id="id24">
<h3>Web service<a class="headerlink" href="#id24" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://features.hillcrestgeo.ca/fwa/functions/fwa_watershedatmeasure.html">FWA_WatershedAtMeasure</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="03_tables.html" class="btn btn-neutral float-left" title="Table reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Simon Norris.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>